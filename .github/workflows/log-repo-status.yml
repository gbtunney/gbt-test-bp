name: log-repo-status

on:
    workflow_call:
        inputs:
            LOG_DIRTY_FILES:
                type: boolean
                default: true
                description: 'Enable logging of dirty (uncommitted) files to console.'
            LOG_IGNORED:
                type: boolean
                default: true
                description: 'Enable logging of ignored files (filtered) to console.'
            includes:
                type: string
                default: 'dist,docs,storybook-static,types'
                description: >
                    Comma-separated list of globs for filtering ignored files (e.g. dist,docs,*.map,!storybook-static).


            DEBUG:
                type: boolean
                default: false
                description: 'If true, prints all ignored files (no filtering), logs extra debug info.'

        outputs:
            status:
                description: 'clean or dirty'
                value: ${{ jobs.check.outputs.status }}
            dirty:
                description: 'true if working directory has uncommitted changes'
                value: ${{ jobs.check.outputs.dirty }}
            files:
                description: 'JSON array of dirty files'
                value: ${{ jobs.check.outputs.files }}
            ignored_files:
                description: 'Filtered ignored files'
                value: ${{ jobs.check.outputs.ignored_files }}
            count:
                description: >
                    JSON object of counts: - dirty: uncommitted files - ignored: filtered ignored files - ignored_all: total ignored files - changed: dirty + filtered - changed_all: dirty + all ignored


                value: ${{ jobs.check.outputs.count }}
            changed:
                description: 'dirty + filtered ignored'
                value: ${{ jobs.check.outputs.changed }}
            changed_all:
                description: 'dirty + all ignored'
                value: ${{ jobs.check.outputs.changed_all }}

jobs:
    check:
        runs-on: ubuntu-latest
        outputs:
            status: ${{ steps.vars.outputs.status }}
            dirty: ${{ steps.vars.outputs.dirty }}
            files: ${{ steps.vars.outputs.dirty_files }}
            ignored_files: ${{ steps.vars.outputs.ignored_filtered }}
            count: ${{ steps.vars.outputs.counts }}
            changed: ${{ steps.vars.outputs.changed }}
            changed_all: ${{ steps.vars.outputs.changed_all }}
        steps:
            - uses: actions/checkout@v4

            - name: 🧼 Check if repo is dirty
              id: detect
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                    echo "status=dirty" >> $GITHUB_OUTPUT
                    echo "dirty=true" >> $GITHUB_OUTPUT
                    echo "⚠️ Repo has uncommitted changes."
                    [[ "${{ inputs.LOG_DIRTY_FILES }}" == "true" ]] && git status --porcelain
                  else
                    echo "status=clean" >> $GITHUB_OUTPUT
                    echo "dirty=false" >> $GITHUB_OUTPUT
                    echo "✅ Repo is clean."
                  fi

            - name: 🧾 Capture dirty files
              id: list_dirty
              run: |
                  git status --porcelain | awk '{print $2}' | jq -R -s -c 'split("\n")[:-1]' > dirty.json
                  echo "dirty_files=$(cat dirty.json)" >> $GITHUB_OUTPUT

            - name: 📦 Capture ignored files (raw and filtered)
              id: list_ignored
              run: |
                  includes="${{ inputs.includes }}"
                  IFS=',' read -ra patterns <<< "$includes"

                  all_ignored=$(git ls-files --others -i --exclude-standard | sort | uniq)
                  echo "$all_ignored" | jq -R -s -c 'split("\n")[:-1]' > ignored_all.json

                  echo "$all_ignored" > all.tmp
                  echo "" > match.tmp
                  for pattern in "${patterns[@]}"; do
                    grep -E "$pattern" all.tmp >> match.tmp 2>/dev/null || true
                  done
                  sort -u match.tmp | jq -R -s -c 'split("\n")[:-1]' > ignored_filtered.json

                  echo "ignored_all=$(cat ignored_all.json)" >> $GITHUB_OUTPUT
                  echo "ignored_filtered=$(cat ignored_filtered.json)" >> $GITHUB_OUTPUT

                  [[ "${{ inputs.LOG_IGNORED }}" == "true" ]] && jq . < ignored_filtered.json
                  [[ "${{ inputs.DEBUG }}" == "true" ]] && jq . < ignored_all.json

            - name: 🧮 Set all outputs and counts
              id: vars
              run: |
                  dirty=$(cat dirty.json)
                  ignored_filtered=$(cat ignored_filtered.json)
                  ignored_all=$(cat ignored_all.json)

                  changed=$(jq -s 'add' <(echo "$dirty") <(echo "$ignored_filtered"))
                  changed_all=$(jq -s 'add' <(echo "$dirty") <(echo "$ignored_all"))

                  count_dirty=$(echo "$dirty" | jq length)
                  count_ignored=$(echo "$ignored_filtered" | jq length)
                  count_ignored_all=$(echo "$ignored_all" | jq length)
                  count_changed=$(echo "$changed" | jq length)
                  count_changed_all=$(echo "$changed_all" | jq length)

                  counts=$(jq -n             --argjson d $count_dirty             --argjson i $count_ignored             --argjson ia $count_ignored_all             --argjson c $count_changed             --argjson ca $count_changed_all             '{dirty: $d, ignored: $i, ignored_all: $ia, changed: $c, changed_all: $ca}')

                  echo "status=${{ steps.detect.outputs.status }}" >> $GITHUB_OUTPUT
                  echo "dirty=${{ steps.detect.outputs.dirty }}" >> $GITHUB_OUTPUT
                  echo "dirty_files=$dirty" >> $GITHUB_OUTPUT
                  echo "ignored_filtered=$ignored_filtered" >> $GITHUB_OUTPUT
                  echo "counts=$counts" >> $GITHUB_OUTPUT
                  echo "changed=$changed" >> $GITHUB_OUTPUT
                  echo "changed_all=$changed_all" >> $GITHUB_OUTPUT
